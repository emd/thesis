\newcommand{\meas}{\text{meas}}
\newcommand{\trig}{\text{trig}}
\newcommand{\Ny}{\text{Ny}}


\chapter{Correlation of \diiid's toroidally separated interferometers}
\label{ch:ToroidalCorrelation}
\graffito{\textcolor{red}{rephrase}}
The toroidal structure of an MHD mode can strongly influence
the mode's stability and its interaction with the surrounding plasma.
A mode's toroidal structure is typically characterized
via the toroidal mode number $n$.
Historically, measurement of toroidal (and poloidal) mode numbers
with magnetic loops has provided rich insight
into the physics governing numerous operational regimes and stability limits.
However, core-localized MHD produces weak signals outside of the plasma volume,
making measurement of the corresponding mode numbers
via magnetic loops difficult or impossible.
Recently, measurements from toroidally separated
electron cyclotron emission imaging (ECEI) systems
on the KSTAR tokamak have identified mode numbers of
edge-localized modes~\cite{lee_rsi_2014} and
sawteeth~\cite{choe_nf_2015},
demonstrating the utility of using more exotic measurements
to probe the structure of core-localized MHD.

This chapter describes the use of toroidally separated interferometers
to measure toroidal mode numbers.
To the author's knowledge, this is the first such implementation in a tokamak.
The addition of the heterodyne interferometer channel
to \diiid's pre-existing phase contrast imaging (PCI) system
enabled this novel measurement.
Section~\ref{sec:ToroidalCorrelation:TwoPointCorrelation}
reviews the mathematics of the two-point correlation technique
used to extract toroidal mode numbers and
derives the resulting Nyquist mode number.
Section~\ref{sec:ToroidalCorrelation:Interferometers}
examines the interferometric measurements in detail and
develops a formula for the measured toroidal mode number.
Section~\ref{sec:ToroidalCorrelation:implementation_details_and_nonideal_effects}
describes the careful efforts to remove time-base discrepancies
between the two interferometer systems and
also discusses the effect of the interferometers' radial offset.
Finally, Section~\ref{sec:ToroidalCorrelation:survey_of_spectra}
surveys representative mode-number spectra
from the toroidally correlated interferometers.


\section{Two-point correlation}
\label{sec:ToroidalCorrelation:TwoPointCorrelation}
Two-point correlation allows inference
of a propagating wave's spatial structure
from measurements made at two distinct spatial locations.
Below,
Section~\ref{sec:ToroidalCorrelation:TwoPointCorrelation:wavenumber_measurement}
details the two-point correlation technique.
Section~\ref{sec:ToroidalCorrelation:TwoPointCorrelation:aliasing}
then discusses the aliasing of large wavenumbers and
establishes the Nyquist wavenumber of a given measurement,
below which wavenumbers are \emph{not} aliased.
Finally,
Section~\ref{sec:ToroidalCorrelation:TwoPointCorrelation:toroidal_mode_numbers}
converts the results of the previous sections
into their toroidal-mode-number equivalents,
as is conventional for fluctuation characterization in a tokamak.


\subsection{Wavenumber measurement via two-point correlation}
\label{sec:ToroidalCorrelation:TwoPointCorrelation:wavenumber_measurement}
Consider a $1$-dimensional, coherent density fluctuation
with amplitude $\tilde{n}_0$, wavenumber $k$, and angular frequency $\omega$
\begin{equation}
  \tilde{n}(z, t)
  =
  \tilde{n}_0
  e^{i(k z - \omega t)}.
  \label{eq:ToroidalCorrelation:coherent_density_fluctuation}
\end{equation}
Imagine that the density is measured
at two locations separated by distance $\Delta z$,
producing two time series, $x(t)$ and $y(t)$, given as
\begin{align}
  x(t)
  &=
  \tilde{n}(z_0, t)
  \\
  y(t)
  &=
  \tilde{n}(z_0 + \Delta z, t)
  =
  x(t) e^{i k \Delta z}.
\end{align}
The cross phase $\alpha_{xy}$ between these two time series is
\begin{align}
  \alpha_{xy}
  &=
  \arg\left[ x^*(t) \cdot y(t) \right]
  \label{eq:ToroidalCorrelation:cross_phase}
  \\
  &=
  k \Delta z,
\end{align}
where $x^*$ is the complex conjugate of $x$.
Thus, a measured wavenumber $k_{\meas}$
can be inferred from the cross phase via
\begin{equation}
  k_{\meas} = \frac{\alpha_{xy}}{\Delta z}.
  \label{eq:ToroidalCorrelation:wavenumber_from_cross_phase}
\end{equation}
The cross phase $\alpha_{xy}$ of $x(t)$ and $y(t)$
can be readily estimated via
the non-parametric, FFT-based
spectral-estimation techniques discussed in
Appendix~\ref{app:SpectralEstimation:NonParametric}.
Note that such cross-phase estimates are frequency-resolved,
allowing simultaneous characterization
of multiple fluctuations at distinct frequencies.


\subsection{Aliasing \& the Nyquist wavenumber}
\label{sec:ToroidalCorrelation:TwoPointCorrelation:aliasing}
The measured wavenumber
(\ref{eq:ToroidalCorrelation:wavenumber_from_cross_phase})
may be \emph{aliased}.
To see this, note that the cross-phase estimate $\alpha_{xy}$
is only unique modulo $2 \pi$
(that is, $0$ is equivalent to $\pm 2 \pi$, $\pm 4 \pi$, etc.).
If the fluctuation wavenumber $k$ is sufficiently large
(i.e.\ if it exceeds the so-called Nyquist wavenumber $k_{\Ny}$),
this cross-phase ambiguity aliases the measured wavenumber
(\ref{eq:ToroidalCorrelation:wavenumber_from_cross_phase})
away from the true wavenumber.

In the most general case,
the wave's propagation direction is not known \emph{a priori}, and
both positive and negative wavenumbers should be considered
(i.e.\ $-\pi < \alpha_{xy} \leq \pi$).
This cross-phase domain yields a Nyquist wavenumber
\begin{equation}
  k_{\Ny} = \frac{\pi}{\Delta z},
  \qquad \text{for \emph{unknown} propagation direction.}
  \label{eq:ToroidalCorrelation:Nyquist_wavenumber_unknown_propagation}
\end{equation}
Wavenumber measurements
(\ref{eq:ToroidalCorrelation:wavenumber_from_cross_phase})
from fluctuations with $|k| > k_{\Ny}$ are aliased, while
measurements from fluctuations with $|k| \leq k_{\Ny}$ are not aliased.
Note that
(\ref{eq:ToroidalCorrelation:Nyquist_wavenumber_unknown_propagation})
is equivalent to the famed Nyquist frequency:
making the transformations $\Delta z \rightarrow 1 / f_s$
for temporal sampling rate $f_s$ and
$k \rightarrow 2 \pi f$,
(\ref{eq:ToroidalCorrelation:Nyquist_wavenumber_unknown_propagation})
readily becomes $f_{\Ny} = f_s / 2$.
Thus, $1 / \Delta z$ can be thought of as the spatial sampling rate,
with a larger sampling rate (i.e.\ smaller $\Delta z$)
allowing un-aliased measurements of larger wavenumbers.

Now, if the wave's propagation direction is known \emph{a priori}
(for example, if the wave propagation is dominated by advection, and
the fluid velocity is well-diagnosed),
only a single polarity of wavenumbers need to be considered.
For concreteness, positive wavenumbers are considered below
(i.e.\ $0 \leq \alpha_{xy} < 2 \pi$).
This cross-phase domain yields a Nyquist wavenumber
\begin{equation}
  k_{\Ny} = \frac{2 \pi}{\Delta z},
  \qquad \text{for \emph{known} propagation direction.}
  \label{eq:ToroidalCorrelation:Nyquist_wavenumber_known_propagation}
\end{equation}


\subsection{Measurement of toroidal mode numbers}
\label{sec:ToroidalCorrelation:TwoPointCorrelation:toroidal_mode_numbers}
Fluctuations in a torus are often characterized
by their toroidal $n$ and poloidal $m$ mode numbers,
both of which are constrained to be integers
by the toroidal and poloidal periodicities, respectively, of the torus.
For a torus with major radius $R$,
the toroidal mode number $n$ is related
to the toroidal wavenumber $k_{\zeta}$ as
\begin{equation}
  k_{\zeta} = \frac{n}{R},
\end{equation}
and the toroidal angular separation $\Delta \zeta$
is related to the spatial separation $\Delta z$ as
\begin{equation}
  \Delta \zeta = \frac{\Delta z}{R}.
\end{equation}
Using these definitions,
the above formulas for the measured wavenumber and the Nyquist wavenumber
can be rewritten in terms of toroidal mode numbers as follows:
\begin{align}
  n_{\text{meas}}
  &=
  \frac{\alpha_{xy}}{\Delta \zeta},
  \label{eq:ToroidalCorrelation:modenumber_from_cross_phase}
  \\
  n_{\text{Ny}}
  &=
  \begin{cases}
    \frac{\pi}{\Delta \zeta}
    \qquad \text{for \emph{unknown} propagation direction} \\
    \frac{2 \pi}{\Delta \zeta}
    \qquad \text{for \emph{known} propagation direction}
  \end{cases}.
  \label{eq:ToroidalCorrelation:Nyquist_modenumber}
\end{align}


\section{Toroidal correlation of interferometers}
\label{sec:ToroidalCorrelation:Interferometers}
This section applies two-point correlation
to the measurement of toroidal mode numbers
with \diiid's toroidally separated, heterodyne CO$_2$ interferometers.
Section~\ref{sec:ToroidalCorrelation:Interferometers:diiid}
describes the geometry of the interferometer probe beams,
which establishes the Nyquist toroidal mode number.
Sections~\ref{sec:ToroidalCorrelation:Interferometers:phase_fluctuations} and
\ref{sec:ToroidalCorrelation:Interferometers:interferometer_measured_mode_number}
then examine the relationship between
the interferometer-measured phase fluctuations and
the toroidal mode number.
As the interferometers are capable of probing the plasma core,
their correlation allows direct measurement
of the toroidal structure of core-localized modes
--- a long-sought after and first-of-its-kind measurement at \diiid.


\subsection{\diiid's interferometers}
\label{sec:ToroidalCorrelation:Interferometers:diiid}
\diiid's multichannel, two-color, heterodyne CO$_2$ interferometer
measures both the equilibrium~\cite{carlstrom_rsi88} and
fluctuating~\cite{vanzeeland_ppcf05, pace_nf17} components
of the line-integrated electron density.
Each channel is configured as a Michelson interferometer,
with each probe beam making a double-pass through the plasma.
The three vertical chords pass through the $V1$, $V2$, and $V3$ ports
at a toroidal location of $240^{\circ}$, while
the radial chord passes through the $R0$ port
at a toroidal location of $225^{\circ}$.
Of particular relevance to this work is the $V2$ interferometer,
which has a major-radial location $R = \SI{1.94}{\meter}$ and
is shown in Fig.~\ref{fig:ToroidalCorrelation:pci_interf_locs}.
The viewing geometry influences
an interferometer's sensitivity to various MHD instabilities;
for example, vertical chords are more sensitive to
toroidal Alfv\'{e}n eigenmodes (TAEs), while
radial chords are more sensitive to
reversed-shear Alfv\'{e}n eigenmodes (RSAEs)
\cite{vanzeeland_ppcf05}.

\begin{figure}
  \centering
  \includegraphics[width = \textwidth]{%
    Chapters/ToroidalCorrelation/figs/pci_interf_locs.pdf}
  \caption[Locations of the $V2$ and PCI interferometer beams on \diiid]{%
    (a) A top-down view of the \diiid\space vessel.
    The toroidal location of the $V2$ interferometer beam
    is $\zeta = 240^{\circ}$,
    and the toroidal location of the PCI beam
    is $\zeta = 285^{\circ}$.
    The \diiid\space sign convention for toroidal mode numbers
    is that $n > 0$ for modes that rotate counterclockwise
    when viewing the torus from above,
    as this corresponds to the direction of dominant torque injection.
    (b) A poloidal cross section of the \diiid\space vessel.
    The major-radial location of the $V2$ interferometer beam
    is $R = \SI{1.94}{\meter}$, and
    the major-radial location of the PCI beam
    is $R = \SI{1.98}{\meter}$.}
\label{fig:ToroidalCorrelation:pci_interf_locs}
\end{figure}

The addition of a heterodyne-interferometer channel
to \diiid's pre-existing phase contrast imaging (PCI) system
is discussed extensively in
Chapter~\ref{ch:Implementation} and
elsewhere~\cite{davis_rsi16}, but
the details of relevance to the toroidal-correlation measurement
are briefly reviewed here.
The PCI probe beam sits at a toroidal location of $285^{\circ}$ and
has a major-radial location $R = \SI{1.98}{\meter}$.
The location of the PCI beampath relative to that of the $V2$ interferometer
is shown in Fig.~\ref{fig:ToroidalCorrelation:pci_interf_locs}.

The geometry of the $V2$ and PCI interferometers
has consequences for the toroidal-correlation measurement.
The interferometers are
toroidally spaced by $\Delta \zeta = 45^{\circ}$
such that the Nyquist toroidal mode number
(\ref{eq:ToroidalCorrelation:Nyquist_modenumber}) becomes
\begin{equation}
  n_{\text{Ny}}
  =
  \begin{cases}
    4
    \qquad \text{for \emph{unknown} propagation direction} \\
    8
    \qquad \text{for \emph{known} propagation direction}
  \end{cases}.
  \label{eq:ToroidalCorrelation:Nyquist_modenumber_interferometers}
\end{equation}
The \diiid\space sign convention for toroidal mode numbers
is indicated in Fig.~\ref{fig:ToroidalCorrelation:pci_interf_locs};
that is, $n > 0$ for modes that rotate counterclockwise
when viewing the torus from above,
as this corresponds to the direction of dominant torque injection.
Consistency with this sign convention requires
that $x(t)$ corresponds to the $V2$ interferometer signal and
that $y(t)$ corresponds to the PCI interferometer signal
when computing the toroidal mode number via
(\ref{eq:ToroidalCorrelation:modenumber_from_cross_phase}).
Finally, the $V2$ and PCI interferometer beam paths have a slight radial offset
($\Delta R = \SI{4}{\centi\meter}$ with
$R_{\text{v2}} = \SI{1.94}{\meter}$ and
$R_{\text{pci}} = \SI{1.98}{\meter}$);
the consequences of this offset are discussed in
Section~\ref{sec:ToroidalCorrelation:implementation_details_and_nonideal_effects:radial_offset}.

For completeness, it should also be mentioned that
a three-chord, radially viewing Faraday-effect polarimeter-interferometer
was recently installed on \diiid's $285^{\circ}$ $R0$ port~\cite{chen_rsi16}.
While diagnosing core-localized magnetic fluctuations
is the primary impetus for this installation,
the system also measures line-integrated electron-density fluctuations.
Presumably, these measurements could be correlated with those from
the $225^{\circ}$ $R0$ CO$_2$ heterodyne interferometer.
However, these two systems do not have phase-locked sampling rates
(the necessity of which is discussed in
Section~\ref{sec:ToroidalCorrelation:implementation_details_and_nonideal_effects:phase_locked_sampling}),
so no attempts to correlate their interferometric measurements
are performed in this work.


\subsection{Interferometer-measured phase fluctuations}
\label{sec:ToroidalCorrelation:Interferometers:phase_fluctuations}
Consider a tokamak electron density fluctuation with
amplitude $\tilde{n}_0(r)$,
toroidal mode number $n$,
poloidal mode number $m$, and
angular frequency $\omega$
\begin{equation}
  \tilde{n}_e(\vect{r}, t)
  =
  \tilde{n}_0(r)
  e^{i \left(n \zeta + m \theta - \omega t \right)}.
\end{equation}
The phase fluctuation (\ref{eq:InterferometricMethods:phase_fluctuation})
imparted to a CO$_2$ probe beam
propagating \emph{vertically} through $\tilde{n}_e(\vect{r}, t)$ becomes
\begin{align}
  \tilde{\phi}
  &=
  - r_e \lambda_0 \int \tilde{n}_e(\vect{r}, t) dz.
  \notag \\
  &=
  \Phi e^{i \left( n \zeta - \omega t \right)},
  \label{eq:ToroidalCorrelation:phase_fluctuations_vertical_beam1}
\end{align}
where
\begin{equation}
  \Phi
  =
  -r_e \lambda_0
  \int \tilde{n}_0(r) e^{i m \theta} dz
\end{equation}
is a complex-valued function of
the beam's major-radial location,
the poloidal mode structure, and
the plasma geometry.
For a given mode and plasma,
the $V2$ and PCI interferometers see the same
poloidal mode structure and plasma geometry such that
$\Phi$ effectively reduces to a one-dimensional function $\Phi = \Phi(R)$.
Further, $\Phi$ can be written explicitly
as a complex value $\Phi = |\Phi| e^{i \sigma}$.
Thus, the phase fluctuation
(\ref{eq:ToroidalCorrelation:phase_fluctuations_vertical_beam1})
can be written alternatively as
\begin{equation}
  \tilde{\phi}
  =
  |\Phi(R)| e^{i[n \zeta - \omega t + \sigma(R)]},
  \label{eq:ToroidalCorrelation:phase_fluctuations_vertical_beam2}
\end{equation}
where the dependence on the major radius $R$ of the beam
has been noted explicitly.


\subsection{Interferometer-measured toroidal mode number}
\label{sec:ToroidalCorrelation:Interferometers:interferometer_measured_mode_number}
Define $x(t)$ and $y(t)$ to be
the $V2$-measured and PCI-measured phase fluctuations, respectively; i.e.\
\begin{align}
  x(t)
  &=
  \tilde{\phi}_{\text{v2}}(t)
  =
  |\Phi(R_{\text{v2}})|
  e^{i[n \zeta_{\text{v2}} - \omega t + \sigma(R_{\text{v2}})]},
  \\
  y(t)
  &=
  \tilde{\phi}_{\text{pci}}(t)
  =
  |\Phi(R_{\text{pci}})|
  e^{i[n \zeta_{\text{pci}} - \omega t + \sigma(R_{\text{pci}})]}.
\end{align}
Then the cross phase (\ref{eq:ToroidalCorrelation:cross_phase}) becomes
\begin{equation}
  \alpha_{xy}
  =
  n \Delta \zeta
  +
  \left[%
    \sigma(R_{\text{pci}})
    -
    \sigma(R_{\text{v2}})
  \right],
\end{equation}
where $\Delta \zeta = \zeta_{\text{pci}} - \zeta_{\text{v2}} = 45^{\circ}$
is the toroidal separation between the interferometer beams.
The cross phase $\alpha_{xy}$ of $x(t)$ and $y(t)$
can be readily estimated via
the non-parametric, FFT-based
spectral-estimation techniques discussed in
Appendix~\ref{app:SpectralEstimation:NonParametric}, but
$\sigma(R_{\text{pci}})$ and $\sigma(R_{\text{v2}})$
are not typically known \emph{a priori}.
Nonetheless, the measured toroidal mode number $n_{\meas}$ is defined as
\begin{equation}
  n_{\meas}
  =
  \frac{\alpha_{xy}}{\Delta \zeta},
  \qquad
  \text{where} \;\, \Delta \zeta = 45^{\circ}.
  \label{eq:ToroidalCorrelation:interferometer_measured_mode_number}
\end{equation}
However, if $\sigma(R_{\text{pci}}) \neq \sigma(R_{\text{v2}})$,
the measured mode number will not be equal to the true mode number
(i.e.\ $n_{\meas} \neq n$).
Further, if the true mode number exceeds the Nyquist mode number
(\ref{eq:ToroidalCorrelation:Nyquist_modenumber_interferometers}),
the measured mode number will be aliased away from the true mode number
(i.e.\ $n_{\meas} \neq n$).


% \subsection{MHD plasma-density perturbations}
% \label{sec:ToroidalCorrelation:Interferometers:MHD_theory}
% An MHD mode displaces a plasma from it's equilibrium position
% by $\vect{\xi} = \vect{\xi}(\vect{r}, t)$.
% The perturbed velocity is given as
% $\vect{v}_1 = \partial \vect{\xi} / \partial t$
% and, assuming harmonic variations, reduces to
% \begin{equation}
%   \vect{v}_1
%   \equiv
%   \frac{\partial \vect{\xi}}{\partial t}
%   =
%   -i \omega \vect{\xi},
%   \notag
% \end{equation}
% where $\omega$ is the mode's angular frequency.
% The plasma density $n_i$ is given as
% \begin{equation}
%   n_i = \bar{n}_i + \tilde{n}_i,
%   \notag
% \end{equation}
% where $\bar{n}_i$ and $\tilde{n}_i$ are
% the equilibrium and fluctuating components, respectively.
% Assuming a stationary equilibrium ($\vect{v}_0 = 0$) and
% using the above relations,
% the linearized continuity equation reduces to
% \begin{equation}
%   \tilde{n}_i = -\nabla \cdot (\bar{n}_i \vect{\xi}).
%   \label{eq:ToroidalCorrelation:density_fluctuations}
% \end{equation}
% If we relax the assumption on $\vect{v}_0$ to allow
% finite equilibrium flow ($\vect{v}_0 \neq 0$),
% then the right-hand side of (\ref{eq:ToroidalCorrelation:density_fluctuations})
% is simply multiplied by the prefactor
% $[1
% - (\vect{v}_0 \cdot \vect{k} / \omega)
% + i (\nabla \cdot \vect{v}_0 / \omega)]^{-1}$, where
% $\vect{k}$ is the mode wavevector.


\section{Implementation details and non-ideal effects}
\label{sec:ToroidalCorrelation:implementation_details_and_nonideal_effects}
Time-base discrepancies and offsets in major-radial position
between the $V2$ and PCI interferometers
can bias the measured mode number \ldots
% (\ref{eq:ToroidalCorrelation:toroidal_mode_number_ideal})
away from the true toroidal mode number $n$.
As discussed below, time-base discrepancies have been eliminated
by phase locking the interferometers' sampling rates
(a hardware solution) and
by post-processing the digitized data
to remove the constant time-base offset
that results from the discrepancy
between each system's nominal and realized trigger times
(a software solution).
The major-radial offset of the interferometer probe beams
can result in tell-tale, artificial mode-number ``flips''.
Barring increased radial overlap (i.e.\ $\Delta R \rightarrow 0$),
interpretation of toroidal mode number measurements
from modes with substantial radial structure
\graffito{\textcolor{red}{forward-modeling ref}}
may require forward modeling.


\subsection{Phase-locked sampling}
\label{sec:ToroidalCorrelation:implementation_details_and_nonideal_effects:phase_locked_sampling}
Extracting useful information
from the correlation of two measurements
requires that the sampling rates of the two measurements
are \emph{phase-locked}.
If the sampling rates are \emph{not} phase-locked,
slippage between the sampling times
will result in artificial evolution of the measured phase.

Digitizing the two signals on a common digitizer
is the simplest method for ensuring phase-locked sampling.
Unfortunately, such an approach is not suitable
for the $V2$ and PCI interferometer signals.
The $V2$ interferometer's
$\Delta f_0 = \SI{40}{\mega\hertz}$ intermediate-frequency signal
is demodulated using an all-digital technique
that mandates a use of a sampling rate
$f_s = (4 / 3) \Delta f_0$
\cite{vanzeeland_rsi08}, and
the baseband $I$ and $Q$ signals never exist in analog form.
In contrast, as described in
Chapter~\ref{ch:Implementation} and \cite{davis_rsi16},
the PCI interferometer's
$\Delta f_0 = \SI{30}{\mega\hertz}$ intermediate-frequency signal
is demodulated with analog electronics, and
the analog baseband $I$ and $Q$ signals
are then digitized on two channels of a D-tAcq ACQ$216$ CPCI board.
Because the $V2$ interferometer's baseband $I$ and $Q$ signals
never exist in analog form,
it is not possible to digitize the $V2$ $I$ and $Q$ signals
on the digitizer used by the PCI interferometer.
Further, because of the intermediate-frequency mismatch
between the $V2$ and PCI interferometers,
it is also not possible digitally demodulate and digitize
the PCI interferometer's $\SI{30}{\mega\hertz}$ intermediate-frequency signal
using the $V2$ interferometer's
$\SI{40}{\mega\hertz}$ digital demodulation system.
An alternative approach is to directly digitize
both intermediate-frequency signals
with a high-bandwidth digitizer and
demodulate both signals in software,
as has been done elsewhere~\cite{mlynek_fst12}.
While \diiid's ion cyclotron emission (ICE) digitizer
has a $200 \, \text{MSPS}$ sample rate,
channels on the ICE digitizer are not consistently available.

As sharing a common digitizer is not possible,
phase-locked sampling between the $V2$ and PCI interferometers
requires that the digitizers of both systems
derive their clocks from a common source.
The $V2$ interferometer derives its clock
from a $\SI{320}{\mega\hertz}$ oven-controlled crystal oscillator (OCXO), and
its digital demodulation system
has two auxiliary outputs that can be programmed
to output phase-locked LVCMOS signals
at $\SI{320}{\mega\hertz} / N$, where
$N \in \{1, 2, 3, ..., 32\}$.
Both outputs are currently programmed with divisor $N = 20$
such that they each provide a $\SI{16}{\mega\hertz}$ clock signal.
One of these $\SI{16}{\mega\hertz}$ clock signals
is routed via an RG-$58$ coaxial cable
from the $V2$ digital demodulation hardware
in the first row of the \diiid\space annex
to the PCI digitizer
in the third row of the \diiid\space annex.

The PCI digitizer typically samples at $f_s = 4 \, \text{MSPS}$.
Thus, division of the $V2$ $\SI{16}{\mega\hertz}$ clock by four
(in hardware or software) yields a clock appropriate for typical sampling.
Each board can accept an external clock
through the front panel's single-pin LEMO CLK input.
The CLK signal passes through an optocoupler
with a bandwidth $\sim \SI{10}{\mega\hertz}$
\cite{milne_optocoupler_pc16}, but
in-house tests have demonstrated
that the input clock frequency
can actually exceed $\SI{16}{\mega\hertz}$.
As a result, the $\SI{16}{\mega\hertz}$ signal
is directly connected to the front-panel CLK lemo input
of the ``master'' digitizer board (``board $8$''), and
the necessary division
(i.e.\ divide by four to achieve typical $4 \, \text{MSPS}$ sampling rate)
is performed within the digitizer board,
which is cleaner, simpler, and more easily extensible
than performing the division in hardware.
The resulting $\SI{4}{\mega\hertz}$ clock
is routed to the ``slave'' digitizer board (``board $7$'')
via the PXI backplane.
The phase-locked sampling of the $V2$ and PCI systems
has been in place since June 2016.


\subsection{Estimating \& compensating the ``trigger offset''}
As discussed in Appendix~\ref{app:DigitizerSynchronization},
phase-locked digitizers can still suffer from
a so-called ``trigger offset'', as defined by
(\ref{eq:DigitizerSynchronization:trigger_offset}).
A finite trigger offset results
(a) when a digitizer triggers at a time $\delta t$ later
than its nominal trigger time and
(b) when the sampling rate deviates from the nominal sampling rate
and the nominal trigger times of both digitizers differ.

% The $V2$ and PCI interferometer sampling rates are phase-locked,
% as both systems share a common clock.
% However, phase-locked sampling rates do \emph{not} guarantee
% identical/ideal \emph{triggering} of both systems, so
% there could very well be an offset between the
% $V2$ and PCI interferometer time bases.
% 
% Imagine that the time bases between $\tilde{\phi}_1$ and $\tilde{\phi}_2$
% are offset by constant $\delta t$ such that
% $t_1 \equiv t$ and $t_2 \equiv t + \delta t$.
% Then, for \emph{constant} angular frequency ($\omega = \text{const}$),
% $\alpha_{12} = n \Delta \zeta - \omega \delta t$
% such that application of
% (\ref{eq:ToroidalCorrelation:toroidal_mode_number_ideal})
% yields a measured mode number
% \begin{equation}
%   n_{\text{meas}} = n - \frac{\omega \delta t}{\Delta \zeta}.
%   \label{eq:ToroidalCorrelation:toroidal_mode_number_dt_constant_omega}
% \end{equation}
% That is, the measured mode number will be biased away from
% the true mode number by a constant DC offset.
% If the true mode number $n$ is known,
% then (\ref{eq:ToroidalCorrelation:toroidal_mode_number_dt_constant_omega})
% can be used to determine the time-base offset $\delta t$.
% 
% Now, in addition to constant time offset $\delta t$,
% imagine that the mode's angular frequency is ramping linearly in time
% ($\dot{\omega} = \partial \omega / \partial t = \text{const}$) such that
% $\omega(t + \delta t) = \omega(t) + \dot{\omega} \delta t$.
% Then,
% $\alpha_{12}
% =
% n \Delta \zeta - [\omega(t)] \delta t - (\dot{\omega} \delta t) t$
% such that application of
% (\ref{eq:ToroidalCorrelation:toroidal_mode_number_ideal})
% yields a measured mode number that also ramps linearly in time
% \begin{equation}
%   \dot{n}_{\text{meas}}
%   =
%   - \left( \frac{2 \dot{\omega}}{\Delta \zeta} \right) \delta t.
%   \label{eq:ToroidalCorrelation:toroidal_mode_number_dt_ramp_rate}
% \end{equation}
% Note that (\ref{eq:ToroidalCorrelation:toroidal_mode_number_dt_ramp_rate}) is
% \emph{independent} of the true toroidal mode number $n$,
% unlike (\ref{eq:ToroidalCorrelation:toroidal_mode_number_dt_constant_omega}).
% Further, if $\delta t$ is ``large''
% (i.e.\ $|\omega \delta t / \Delta \zeta| > n_{\text{Ny}}$),
% $n_{\text{meas}}$ may be aliased and application of
% (\ref{eq:ToroidalCorrelation:toroidal_mode_number_dt_constant_omega})
% will give an incorrect value for $\delta t$.
% Thus, if the frequency of the mode is ramping \emph{and}
% the measured toroidal mode number $n_{\text{meas}}$ is also ramping in time,
% (\ref{eq:ToroidalCorrelation:toroidal_mode_number_dt_ramp_rate})
% can be used to determine the time-base offset $\delta t$ and
% is superior to application of
% (\ref{eq:ToroidalCorrelation:toroidal_mode_number_dt_constant_omega}).
% 
% \graffito{\textcolor{red}{Improve explanation}}
% To make use of (\ref{eq:ToroidalCorrelation:toroidal_mode_number_dt_ramp_rate}),
% $\dot{\omega}$ must be computed from experimental measurements.
% Note that the \emph{measured} angular frequency is given as
% $\omega_{\text{meas}} \equiv \partial[\omega(t) \cdot t] / \partial t$.
% In the case where $\omega = \text{const}$,
% this yields the expected result that $\omega_{\text{meas}} = \omega$.
% However, if the angular frequency is ramping linearly in time
% ($\omega(t) = \omega_0 + \dot{\omega} t$), then
% $\omega_{\text{meas}} = \omega_0 + 2 \dot{\omega} t$ and
% $\dot{\omega}_{\text{meas}} = 2 \dot{\omega}$.
% Thus, (\ref{eq:ToroidalCorrelation:toroidal_mode_number_dt_ramp_rate}) becomes
% \begin{equation}
%   \dot{n}_{\text{meas}}
%   =
%   - \left( \frac{\dot{\omega}_{\text{meas}}}{\Delta \zeta} \right) \delta t.
%   \label{eq:ToroidalCorrelation:toroidal_mode_number_dt_ramp_rate_lab_frame}
% \end{equation}

\begin{figure}
  \centering
  \includegraphics[width = \textwidth]{%
    Chapters/ToroidalCorrelation/figs/trigger_offset.pdf}
  \caption[``Trigger offset'' compensation]{%
    Interferometer-measured toroidal mode numbers
    (a) \emph{without} compensation for the trigger offset and
    (b) \emph{with} compensation for the trigger offset.
    In (a), the finite trigger offset
    (\ref{eq:ToroidalCorrelation:trigger_offset_optimized})
    results in the unphysical evolution
    of the measured toroidal mode numbers.
    The trigger offset is roughly estimated
    from the measured mode-number evolution
    between the red circular annotations
    to the lower-frequency mode
    ($\Delta f \approx \SI{20}{\kilo\hertz}$ and
    $\Delta n \approx 5$; note that $\Delta n_{\meas}$
    refers to the total number of mode numbers evolved through,
    i.e.\ it is path-dependent and is \emph{not} simply
    the difference between the final and initial $n_{\meas}$).
    In (b), the digital records of both interferometers
    have been synchronized by compensating for the finite trigger offset
    (\ref{eq:ToroidalCorrelation:trigger_offset_optimized}), and
    the measured toroidal mode numbers are constant in time,
    consistent with physical expectations.
  }
\label{fig:ToroidalCorrelation:trigger_offset}
\end{figure}

A finite trigger offset biases mode-number measurements.
For example, Fig.~\ref{fig:ToroidalCorrelation:trigger_offset}(a)
displays the toroidal mode numbers of two coherent modes
as measured by the uncompensated interferometers.
Note that the measured mode number of each mode
(unphysically) evolves with the mode frequency,
which is consistent
(see (\ref{eq:DigitizerSynchronization:measured_phase_difference}))
with the presence of a finite trigger offset
between the interferometer measurements.
Referencing
(\ref{eq:DigitizerSynchronization:trigger_offset_estimate_frequency_swept}),
the trigger offset can be estimated
from the measured mode-number evolution
during a linear frequency sweep as
\begin{align}
  \delta t_{\trig}
  =
  \frac{d \alpha_{xy}}{d\omega}
  \approx
  \frac{\Delta \alpha_{xy}}{\Delta \omega}
  \approx
  \SI{30}{\micro\second},
\end{align}
where
$\Delta \alpha_{xy} = \Delta \zeta \cdot \Delta n_{\meas}$
is the measured phase-angle change and
$\Delta \zeta = \pi / 4$
is the angular separation of the interferometers
(consistent with
(\ref{eq:ToroidalCorrelation:interferometer_measured_mode_number}));
here, the numerical value results from
$\Delta n_{\meas} \approx 5$ and
$\Delta \omega \approx 2 \pi \cdot \SI{20}{\kilo\hertz}$,
as indicated by the red circular annotations
to the lower-frequency mode in
Fig.~\ref{fig:ToroidalCorrelation:trigger_offset}(a).
Note that $\delta t_{\trig} > 0$
implies that the actual sampling times
of the PCI interferometer lag (i.e.\ occur later than)
those of the $V2$ interferometer, as shown schematically in
Fig.~\ref{fig:DigitizerSynchronization:trigger_offset_schematic}.
Applying standard techniques~\cite[Sec.~4.5]{oppenheim}
in post-processing software
to eliminate this $\SI{30}{\micro\second}$ timebase discrepancy
dramatically reduces the unphysical mode-number evolution observed in
Fig.~\ref{fig:ToroidalCorrelation:trigger_offset}(a).
Scanning $\delta t_{\trig}$ about $\SI{30}{\micro\second}$
shows that the unphysical mode-number evolution is minimized for
\begin{equation}
  \delta t_{\trig}
  =
  \SI{32.5}{\micro\second}.
  \label{eq:ToroidalCorrelation:trigger_offset_optimized}
\end{equation}
Fig.~\ref{fig:ToroidalCorrelation:trigger_offset}(b)
displays the interferometer-measured toroidal mode numbers
after compensating for trigger offset
(\ref{eq:ToroidalCorrelation:trigger_offset_optimized});
note that the mode numbers are constant in time,
consistent with physical expectations.
It should be emphasized that the only difference between
Fig.~\ref{fig:ToroidalCorrelation:trigger_offset}(a) and
Fig.~\ref{fig:ToroidalCorrelation:trigger_offset}(b)
is the compensation of trigger offset
(\ref{eq:ToroidalCorrelation:trigger_offset_optimized}).

\begin{itemize}
  \item Explanation for $\Delta n_{\meas}$
  \item Comparison to magnetics
  \item Origin of trigger offset
\end{itemize}

For comparison, the corresponding (but with zero trigger offset)
poloidal magnetic-field fluctuation spectrum~\cite{strait_rsi06}
is also shown.
The two spectra very clearly differ.

\textcolor{red}{Note that additional measurements are needed
to determine which clock is correct in the \emph{absolute} sense.
For example, we can try digitizing a trigger signal and
comparing the digitized time of the trigger to the ``nominal'' trigger time
to determine the offset of our digitizer from the DIII-D clock.}

\begin{figure}
  \centering
  \includegraphics[width = \textwidth]{%
    Chapters/ToroidalCorrelation/figs/magnetics_and_interferometer_mode_numbers_167341.eps}
  \caption[Computed toroidal mode numbers \emph{after} removing time delay
      from \ldots  % Fig.~\ref{fig:ToroidalCorrelation:uncompensated_time_delay}
    ]{%
    Computed mode numbers from
    toroidally separated interferometers and magnetics.
    Here, the PCI-interferometer signal has been delayed by
    $\SI{32}{\micro\second}$ relative to the $V2$ signal
    to account for the time offset between each system's native time base.
    Note that the agreement with magnetics is excellent and that
    the mode numbers of the ramping-frequency modes are no longer
    artificially ramping;
    this is an enormous improvement over the corresponding
    uncompensated interferometer-measured spectrum in\ldots
    % Fig.~\ref{fig:ToroidalCorrelation:uncompensated_time_delay}.
  }
\label{fig:ToroidalCorrelation:compensated_time_delay}
\end{figure}


\subsection{Effects of radial offset}
\label{sec:ToroidalCorrelation:implementation_details_and_nonideal_effects:radial_offset}
\begin{itemize}
  \item \textcolor{red}{ECE to confirm radial mode structure}
  \item \textcolor{red}{Correlate $V1$, $V2$, $V3$ to see just radial effect}
\end{itemize}
The $V2$ and PCI interferometer beam paths have a slight radial offset
($\Delta R = \SI{4}{\centi\meter}$ with
$R_{\text{V2}} = \SI{1.94}{\meter}$ and $R_{\text{PCI}} = \SI{1.98}{\meter}$).
Thus, $\alpha_{12} = n(\zeta_2 - \zeta_1) + [\sigma(R_2) - \sigma(R_1)]$,
where
\begin{equation}
  \sigma(R_2) - \sigma(R_1)
  \approx
  \begin{cases}
    0, & \quad \text{$\vect{\xi}(R_1)$ and $\vect{\xi}(R_2)$ in-phase} \\
    \pi, & \quad \text{$\vect{\xi}(R_1)$ and $\vect{\xi}(R_2)$ out-of-phase}
  \end{cases},
  \notag
\end{equation}
gives the relative phase of $\vect{\xi}$
at $R_2$ relative to that at $R_1$.
If $\vect{\xi}(R_1)$ and $\vect{\xi}(R_2)$ are in-phase,
then application of \ldots  % (\ref{eq:ToroidalCorrelation:toroidal_mode_number_ideal})
will yield the correct mode number.
However, if $\vect{\xi}(R_1)$ and $\vect{\xi}(R_2)$ are out-of-phase,
then application of\ldots  % (\ref{eq:ToroidalCorrelation:toroidal_mode_number_ideal})
will yield a measured mode number $n_{\text{meas}}$
\graffito{\textcolor{red}{Correct sign for alias??}}
\begin{equation}
  n_{\text{meas}}
  =
  \begin{cases}
    n + n_{\text{Ny}}, & \quad n \leq 0 \\
    n - n_{\text{Ny}}, & \quad n > 0
  \end{cases},
  \label{eq:ToroidalCorrelation:toroidal_mode_number_radially_out_of_phase}
\end{equation}
where $n_{\text{Ny}} \equiv \pi / \Delta \zeta$
is the Nyquist toroidal mode number, and
the $n > 0$ case results from \emph{aliasing}
(that is, $n + n_{\text{Ny}} \rightarrow n - n_{\text{Ny}}$
when $n > 0$ because of aliasing).
Lacking additional measurements or some type of forward modeling,
this incorrect mode-number identification may go undiagnosed.
However, if $\vect{\xi}(R)$ evolves such that
$\vect{\xi}(R_1)$ and $\vect{\xi}(R_2)$ transition
from being in-phase to being out-of-phase (or vice versa),
the measured mode number will ``flip'';
an example of this mode-number ``flipping''
is shown in Fig.~\ref{fig:ToroidalCorrelation:mode_number_flips}.
Further effects of the radial offset can be investigated
via forward modeling.

\begin{figure}
  \centering
  \includegraphics[width = 0.5 \textwidth]{%
    Chapters/ToroidalCorrelation/figs/phase_flips_167341.eps}
  \caption[Mode-number ``flipping'' due to the small radial offset
      between the $V2$ and PCI interferometers]{%
    Due to the small radial offset ($\Delta R = \SI{4}{\centi\meter}$)
    between the $V2$ and PCI interferometers,
    changes in the radial structure of a mode
    can result in ``flipping'' of the interferometer-measured mode number.
    Here, the mode number flips from $n = 2$ to $n = -2$,
    consistent with \ldots
    % (\ref{eq:ToroidalCorrelation:toroidal_mode_number_radially_out_of_phase}).
    Lacking additional measurements or some type of forward modeling,
    it is impossible to determine if the mode is truly $n = 2$ or $n = -2$.
    Note that these modes exceed the typical bandwidth of magnetics, however,
    so even identification as $n = \pm 2$ \emph{is} an improvement!}
\label{fig:ToroidalCorrelation:mode_number_flips}
\end{figure}


\section{Example mode number spectra}
\label{sec:ToroidalCorrelation:survey_of_spectra}
\textcolor{red}{%
  This section contains representative results
  from the toroidal correlation measurement
  obtained over the very brief ``metal-rings'' campaign (June 2016).
  This is \emph{not} a complete section,
  as it consists solely of figures and detailed captions.
  This is intended to be a survey of current measurements.
  In the final version of my thesis,
  some of these figures (or variants thereof)
  may be moved to other chapters, and
  I may decide to only keep a few of the figures
  in this section for detailed discussion.
  Obviously, your insight will be helpful
  for pruning and focusing this section.
}

\begin{figure}[h!]
  \centering
  \includegraphics[width = \textwidth]{%
    Chapters/ToroidalCorrelation/figs/magnetics_and_interferometer_mode_numbers_167340.eps}
  \caption[Another example of excellent agreement between the
      interferometer and magnetics mode number spectra]{%
    Another example of excellent agreement between the
    interferometer and magnetics mode number spectra. Note that
    the interferometers additionally see modes \emph{invisible} to magnetics.
    Here,the modes were \emph{assumed} to be rotating
    in the ``positive'' direction
    (i.e.\ counterclockwise when viewing the torus from above,
    as this corresponds to the direction of dominant torque injection)
    such that we can discriminate $0 \leq n < 8$
    (rather than the typical $-4 < n \leq 4$).}
\label{fig:ToroidalCorrelation:magnetics_corroboration_2}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[width = 0.8 \textwidth]{%
    Chapters/ToroidalCorrelation/figs/core_localized_167342.eps}
  \caption[Toroidal mode numbers of \emph{core-localized} MHD]{%
    Between $1.8 \leq t \, [\text{s}] \leq 2.2$,
    the correlated interferometers measure fluctuations
    (Alfv\'{e}n eigenmodes?) that are \emph{invisible} to magnetics.
    This suggests that the modes are \emph{core-localized} and
    that the correlated interferometers are indeed capable
    of measuring core-localized MHD!
    (Note that the fast magnetic probes have a \SI{1}{\mega\hertz} bandwidth,
    but they do not have significant toroidal separation,
    preventing accurate measurement of toroidal mode numbers).}
\label{fig:ToroidalCorrelation:core_localized}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[width = \textwidth]{%
    Chapters/ToroidalCorrelation/figs/AEs_167550.eps}
  \caption[Toroidal mode numbers of Alfv\'{e}n eigenmodes]{%
    Alfv\'{e}n eigenmodes visible
    on the correlated interferometers.
    These modes are not readily visible on magnetics.}
\label{fig:ToroidalCorrelation:AEs}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[width = 0.7 \textwidth]{%
    Chapters/ToroidalCorrelation/figs/interELM_fast_167578.eps}
  \caption[Toroidal mode numbers of inter-ELM fluctuations]{%
    Inter-ELM fluctuations as measured by
    the correlated interferometers and fast magnetics.
    The mode frequency ramps early in the inter-ELM window before saturating;
    the magnetic component of the fluctuation only appears \emph{after}
    the mode frequency has saturated --- fascinating!
    (Note that the fast magnetic probes have a \SI{1}{\mega\hertz} bandwidth,
    but they do not have significant toroidal separation,
    preventing accurate measurement of toroidal mode numbers).
    The drive and significance of such fluctuations is not known, but
    they do \emph{not} occur in every ELMy discharge.}
\label{fig:ToroidalCorrelation:interELM_fast}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[width = 0.5 \textwidth]{%
    Chapters/ToroidalCorrelation/figs/EHO_167587.eps}
  \caption[Toroidal mode numbers of the edge harmonic oscillation (EHO)]{%
    The magnetics and interferometers both see the
    edge harmonic oscillation (EHO), which is responsible for
    flushing impurities from quiescent H-mode (QH-mode) plasmas.
    Below \SI{20}{\kilo\hertz}, the magnetics and interferometers
    both measure the same toroidal mode numbers; however,
    above \SI{20}{\kilo\hertz}, the measured mode numbers differ,
    likely due to a combination of aliasing and the small radial offset
    of the two interferometer beams.}
\label{fig:ToroidalCorrelation:EHO}
\end{figure}

\begin{figure}[h!]
  \centering
  \includegraphics[width = 0.75 \textwidth]{%
    Chapters/ToroidalCorrelation/figs/interferometer_vs_PCI_coherence.eps}
  \caption[Inability to correlate $V2$ and PCI]{%
    The magnitude-squared coherence $\gamma_{xy}^2$ between
    the $V2$ and 285 interferometers (left) and
    between the $V2$ interferometer and PCI (right).
    The high coherence between the $V2$ and 285 interferometers
    allows accurate measurement of toroidal mode numbers,
    as demonstrated by the corresponding mode number spectrum
    displayed in Fig.~\ref{fig:ToroidalCorrelation:compensated_time_delay},
    whereas the poor coherence between the $V2$ and PCI
    prevents such measurements.
    (Note that ``285 interferometer'' refers to
    the newly installed interferometer channel of the PCI).}
\label{fig:ToroidalCorrelation:PCI_coherence}
\end{figure}


\bibliographystyle{plainurl}
\bibliography{references}
